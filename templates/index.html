<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS 3000 â€¢ LIVING AI AVATAR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            min-height: 100vh;
            color: #00ffff;
            overflow: hidden;
            position: relative;
            cursor: none;
        }
        
        /* Cosmic Cursor */
        .cosmic-cursor {
            position: fixed;
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, rgba(0, 255, 255, 0.8), transparent);
            border-radius: 50%;
            pointer-events: none;
            z-index: 10000;
            transition: transform 0.1s ease;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.6);
        }
        
        /* Space Background */
        .space-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 120%;
            height: 120%;
            background: 
                radial-gradient(ellipse at 20% 30%, #1a0033 0%, transparent 50%), 
                radial-gradient(ellipse at 80% 70%, #0d1421 0%, transparent 50%), 
                linear-gradient(125deg, #000011 0%, #0a0a0f 30%, #1a0033 60%, #000022 100%);
            animation: galaxyRotation 300s linear infinite;
            z-index: -10;
        }
        
        /* Stars */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(1px 1px at 120px 80px, #ffffff, transparent), 
                radial-gradient(2px 2px at 350px 200px, #00f5ff, transparent), 
                radial-gradient(1px 1px at 580px 120px, #ffffff, transparent);
            background-size: 1200px 600px;
            animation: starfieldSlow 400s linear infinite;
            z-index: -8;
        }
        
        /* Main Container */
        .avatar-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Room Environment */
        .room {
            position: absolute;
            width: 80%;
            height: 60%;
            background: linear-gradient(180deg, rgba(20, 40, 80, 0.3) 0%, rgba(10, 20, 40, 0.5) 100%);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 50px rgba(0, 255, 255, 0.2);
        }
        
        /* Room Objects */
        .tv {
            position: absolute;
            top: 20%;
            left: 10%;
            width: 120px;
            height: 80px;
            background: #222;
            border: 3px solid #444;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }
        
        .tv-screen {
            position: absolute;
            top: 8px;
            left: 8px;
            width: calc(100% - 16px);
            height: calc(100% - 16px);
            background: #000;
            border-radius: 4px;
            opacity: 0.3;
            transition: all 0.3s ease;
        }
        
        .tv-screen.active {
            opacity: 1;
            background: linear-gradient(45deg, #0088ff, #ff0088, #00ff88, #8800ff);
            background-size: 400% 400%;
            animation: tvContent 2s ease-in-out infinite;
        }
        
        .couch {
            position: absolute;
            bottom: 15%;
            left: 5%;
            width: 140px;
            height: 60px;
            background: linear-gradient(180deg, #444, #222);
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
        }
        
        .desk {
            position: absolute;
            top: 25%;
            right: 15%;
            width: 100px;
            height: 60px;
            background: linear-gradient(180deg, #333, #111);
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
        }
        
        .desk-computer {
            position: absolute;
            top: -15px;
            left: 20px;
            width: 60px;
            height: 40px;
            background: #222;
            border: 2px solid #444;
            border-radius: 4px;
        }
        
        .window {
            position: absolute;
            top: 10%;
            right: 5%;
            width: 80px;
            height: 100px;
            background: linear-gradient(180deg, rgba(0, 150, 255, 0.3), rgba(0, 255, 150, 0.2));
            border: 3px solid rgba(0, 255, 255, 0.5);
            border-radius: 8px;
        }
        
        .exercise-mat {
            position: absolute;
            bottom: 20%;
            right: 20%;
            width: 80px;
            height: 120px;
            background: rgba(255, 0, 150, 0.3);
            border: 2px solid rgba(255, 0, 150, 0.5);
            border-radius: 40px;
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .exercise-mat.active {
            opacity: 1;
        }
        
        /* Human Avatar */
        .avatar {
            position: absolute;
            width: 80px;
            height: 120px;
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
        }
        
        /* Avatar Head */
        .avatar-head {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, rgba(255, 220, 180, 0.9), rgba(200, 150, 120, 0.8));
            border: 2px solid #00ffff;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }
        
        .avatar-eyes {
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }
        
        .avatar-eye {
            width: 6px;
            height: 6px;
            background: #000;
            border-radius: 50%;
            transition: all 0.2s ease;
        }
        
        .avatar-mouth {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 6px;
            background: #000;
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        
        /* Avatar Body */
        .avatar-body {
            position: absolute;
            top: 35px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 45px;
            background: linear-gradient(180deg, #0088ff, #0066cc);
            border: 2px solid #00ffff;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
        }
        
        /* Avatar Arms */
        .avatar-arms {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 30px;
        }
        
        .avatar-arm {
            position: absolute;
            width: 20px;
            height: 8px;
            background: linear-gradient(90deg, #0088ff, #0066cc);
            border: 1px solid #00ffff;
            border-radius: 4px;
            transform-origin: center left;
            transition: all 0.3s ease;
        }
        
        .avatar-arm.left {
            top: 5px;
            left: 0;
        }
        
        .avatar-arm.right {
            top: 5px;
            right: 0;
            transform-origin: center right;
        }
        
        /* Avatar Legs */
        .avatar-legs {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 40px;
        }
        
        .avatar-leg {
            position: absolute;
            width: 12px;
            height: 35px;
            background: linear-gradient(180deg, #004499, #003366);
            border: 1px solid #00ffff;
            border-radius: 6px;
            transform-origin: top center;
            transition: all 0.3s ease;
        }
        
        .avatar-leg.left {
            left: 2px;
        }
        
        .avatar-leg.right {
            right: 2px;
        }
        
        /* Voice Status */
        .voice-status {
            position: absolute;
            top: -60px;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 16px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ffff;
            border-radius: 20px;
            color: #00ffff;
            font-size: 12px;
            opacity: 0;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .voice-status.show {
            opacity: 1;
        }
        
        /* Activity Indicator */
        .activity-indicator {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            opacity: 0;
            transition: all 0.3s ease;
            animation: float 2s ease-in-out infinite;
        }
        
        .activity-indicator.show {
            opacity: 1;
        }
        
        /* Title */
        .title {
            position: absolute;
            top: 5%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 3em;
            background: linear-gradient(45deg, #00ffff, #ff00ff, #ffff00, #00ffff);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 8px;
            animation: glow 3s ease-in-out infinite alternate, gradientShift 6s ease-in-out infinite;
            text-align: center;
            font-weight: bold;
        }
        
        /* Status Bar */
        .status-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ffff;
            border-radius: 25px;
            padding: 10px 20px;
            color: #00ffff;
            backdrop-filter: blur(10px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .status-bar.show {
            opacity: 1;
        }
        
        /* Start Overlay */
        .start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(15px);
        }
        
        .start-button {
            font-family: 'Courier New', monospace;
            font-size: 2em;
            color: #00ffff;
            background: linear-gradient(45deg, rgba(0, 255, 255, 0.1), rgba(255, 0, 255, 0.1));
            border: 4px solid #00ffff;
            padding: 30px 60px;
            border-radius: 20px;
            cursor: pointer;
            text-shadow: 0 0 25px #00ffff;
            box-shadow: 0 0 60px rgba(0, 255, 255, 0.5);
            animation: holoPulse 2s infinite;
            text-transform: uppercase;
            letter-spacing: 4px;
            user-select: none;
        }
        
        .start-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 80px rgba(0, 255, 255, 0.7);
        }
        
        /* Animations */
        @keyframes galaxyRotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes starfieldSlow {
            0% { transform: translateY(0px); }
            100% { transform: translateY(-600px); }
        }
        
        @keyframes tvContent {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        @keyframes float {
            0%, 100% { transform: translateX(-50%) translateY(0px); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }
        
        @keyframes glow {
            0% { text-shadow: 0 0 40px rgba(0, 255, 255, 0.9); }
            100% { text-shadow: 0 0 80px rgba(0, 255, 255, 1), 0 0 120px rgba(255, 0, 255, 0.6); }
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        @keyframes holoPulse {
            0%, 100% { opacity: 0.8; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }
        
        @keyframes walkCycle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(15deg); }
            75% { transform: rotate(-15deg); }
        }
        
        @keyframes armSwing {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(20deg); }
            75% { transform: rotate(-20deg); }
        }
        
        @keyframes pushupMotion {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(15px); }
        }
        
        @keyframes stretchArms {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(45deg); }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .title { 
                font-size: 2em; 
                letter-spacing: 4px; 
            }
            
            .room { 
                width: 90%; 
                height: 50%; 
            }
            
            .avatar { 
                width: 60px; 
                height: 90px; 
            }
        }
    </style>
</head>
<body>
    <div class="cosmic-cursor" id="cosmicCursor"></div>
    
    <div class="start-overlay" id="startOverlay">
        <button class="start-button" id="startButton">Activate Living Avatar</button>
    </div>

    <div class="space-bg"></div>
    <div class="stars"></div>

    <div class="title">NEXUS 3000 â€¢ LIVING AI</div>

    <div class="avatar-container">
        <!-- Room Environment -->
        <div class="room" id="room">
            <!-- Room Objects -->
            <div class="tv" id="tv">
                <div class="tv-screen" id="tvScreen"></div>
            </div>
            <div class="couch" id="couch"></div>
            <div class="desk" id="desk">
                <div class="desk-computer" id="computer"></div>
            </div>
            <div class="window" id="window"></div>
            <div class="exercise-mat" id="exerciseMat"></div>
            
            <!-- Human Avatar -->
            <div class="avatar" id="avatar">
                <div class="avatar-head">
                    <div class="avatar-eyes">
                        <div class="avatar-eye" id="leftEye"></div>
                        <div class="avatar-eye" id="rightEye"></div>
                    </div>
                    <div class="avatar-mouth" id="mouth"></div>
                </div>
                <div class="avatar-body"></div>
                <div class="avatar-arms">
                    <div class="avatar-arm left" id="leftArm"></div>
                    <div class="avatar-arm right" id="rightArm"></div>
                </div>
                <div class="avatar-legs">
                    <div class="avatar-leg left" id="leftLeg"></div>
                    <div class="avatar-leg right" id="rightLeg"></div>
                </div>
                
                <div class="voice-status" id="voiceStatus">Listening...</div>
                <div class="activity-indicator" id="activityIndicator">ðŸ¤–</div>
            </div>
        </div>
    </div>

    <div class="status-bar" id="statusBar">Initializing...</div>

    <!-- Hidden elements for camera/audio -->
    <video id="videoElement" autoplay muted playsinline style="position: absolute; top: -9999px; left: -9999px; width: 1px; height: 1px;"></video>
    <audio id="silentAudio" muted></audio>

    <script>
        // Core State Management
        let isListening = false;
        let isSpeaking = false;
        let canListen = true;
        let recognition = null;
        let sessionId = Math.random().toString(36).substr(2, 9);
        let currentActivity = null;
        let activityTimer = null;
        let lastInteraction = Date.now();
        let hasGreeted = false;
        let cameraActive = false;

        // Platform detection
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isAndroid = /Android/.test(navigator.userAgent);

        // DOM Elements
        const avatar = document.getElementById('avatar');
        const voiceStatus = document.getElementById('voiceStatus');
        const activityIndicator = document.getElementById('activityIndicator');
        const statusBar = document.getElementById('statusBar');
        const tvScreen = document.getElementById('tvScreen');
        const exerciseMat = document.getElementById('exerciseMat');
        const leftEye = document.getElementById('leftEye');
        const rightEye = document.getElementById('rightEye');
        const mouth = document.getElementById('mouth');
        const leftArm = document.getElementById('leftArm');
        const rightArm = document.getElementById('rightArm');
        const leftLeg = document.getElementById('leftLeg');
        const rightLeg = document.getElementById('rightLeg');

        // Avatar Activities - Real behaviors that change the scene
        const activities = [
            {
                name: 'watching TV',
                emoji: 'ðŸ“º',
                duration: 8000,
                execute: watchTV,
                position: { bottom: '25%', left: '25%' }
            },
            {
                name: 'working at desk',
                emoji: 'ðŸ’»',
                duration: 10000,
                execute: workAtDesk,
                position: { top: '35%', right: '25%' }
            },
            {
                name: 'exercising',
                emoji: 'ðŸ’ª',
                duration: 6000,
                execute: exercise,
                position: { bottom: '30%', right: '30%' }
            },
            {
                name: 'looking out window',
                emoji: 'ðŸªŸ',
                duration: 5000,
                execute: lookOutWindow,
                position: { top: '25%', right: '15%' }
            },
            {
                name: 'relaxing on couch',
                emoji: 'ðŸ›‹ï¸',
                duration: 7000,
                execute: relaxOnCouch,
                position: { bottom: '25%', left: '15%' }
            },
            {
                name: 'pacing around',
                emoji: 'ðŸš¶',
                duration: 8000,
                execute: paceAround,
                position: null // Dynamic movement
            },
            {
                name: 'thinking',
                emoji: 'ðŸ¤”',
                duration: 4000,
                execute: think,
                position: { top: '50%', left: '50%' }
            },
            {
                name: 'stretching',
                emoji: 'ðŸ¤¸',
                duration: 5000,
                execute: stretch,
                position: { bottom: '35%', left: '45%' }
            }
        ];

        // Activity Functions - These create real visual changes
        function watchTV() {
            console.log("ðŸ¤– Avatar is watching TV");
            moveAvatarTo({ bottom: '25%', left: '25%' });
            tvScreen.classList.add('active');
            
            // Face the TV
            setTimeout(() => {
                avatar.style.transform += ' scaleX(-1)'; // Face left toward TV
                
                // Simulate watching - eyes follow TV content
                let watchInterval = setInterval(() => {
                    if (currentActivity?.name !== 'watching TV') {
                        clearInterval(watchInterval);
                        return;
                    }
                    
                    leftEye.style.transform = `translateX(${Math.sin(Date.now() / 1000) * 2}px)`;
                    rightEye.style.transform = `translateX(${Math.sin(Date.now() / 1000) * 2}px)`;
                }, 200);
                
                setTimeout(() => clearInterval(watchInterval), 7000);
            }, 1000);
        }

        function workAtDesk() {
            console.log("ðŸ¤– Avatar is working at desk");
            moveAvatarTo({ top: '45%', right: '35%' });
            
            setTimeout(() => {
                // Typing animation
                let typingInterval = setInterval(() => {
                    if (currentActivity?.name !== 'working at desk') {
                        clearInterval(typingInterval);
                        return;
                    }
                    
                    leftArm.style.transform = `rotate(${Math.sin(Date.now() / 200) * 15 - 10}deg)`;
                    rightArm.style.transform = `rotate(${Math.cos(Date.now() / 200) * 15 + 10}deg)`;
                }, 100);
                
                setTimeout(() => {
                    clearInterval(typingInterval);
                    resetArmPositions();
                }, 8000);
            }, 1000);
        }

        function exercise() {
            console.log("ðŸ¤– Avatar is exercising");
            exerciseMat.classList.add('active');
            moveAvatarTo({ bottom: '30%', right: '30%' });
            
            setTimeout(() => {
                // Pushup animation
                let pushupCount = 0;
                let exerciseInterval = setInterval(() => {
                    if (currentActivity?.name !== 'exercising') {
                        clearInterval(exerciseInterval);
                        return;
                    }
                    
                    if (pushupCount % 2 === 0) {
                        avatar.style.transform += ' translateY(10px)';
                        leftArm.style.transform = 'rotate(-45deg)';
                        rightArm.style.transform = 'rotate(45deg)';
                    } else {
                        avatar.style.transform = avatar.style.transform.replace('translateY(10px)', '');
                        resetArmPositions();
                    }
                    pushupCount++;
                }, 800);
                
                setTimeout(() => {
                    clearInterval(exerciseInterval);
                    exerciseMat.classList.remove('active');
                }, 5000);
            }, 1000);
        }

        function lookOutWindow() {
            console.log("ðŸ¤– Avatar is looking out window");
            moveAvatarTo({ top: '35%', right: '25%' });
            
            setTimeout(() => {
                // Look up and around as if watching outside
                leftEye.style.transform = 'translateY(-2px)';
                rightEye.style.transform = 'translateY(-2px)';
                
                let gazeInterval = setInterval(() => {
                    if (currentActivity?.name !== 'looking out window') {
                        clearInterval(gazeInterval);
                        return;
                    }
                    
                    const direction = Math.sin(Date.now() / 2000) * 3;
                    leftEye.style.transform = `translateY(-2px) translateX(${direction}px)`;
                    rightEye.style.transform = `translateY(-2px) translateX(${direction}px)`;
                }, 200);
                
                setTimeout(() => {
                    clearInterval(gazeInterval);
                    resetEyePositions();
                }, 4000);
            }, 1000);
        }

        function relaxOnCouch() {
            console.log("ðŸ¤– Avatar is relaxing on couch");
            moveAvatarTo({ bottom: '35%', left: '15%' });
            
            setTimeout(() => {
                // Relaxed posture
                avatar.style.transform += ' scale(0.9)'; // Slightly smaller, more relaxed
                leftArm.style.transform = 'rotate(-20deg)';
                rightArm.style.transform = 'rotate(20deg)';
                
                // Slow breathing animation
                let breathInterval = setInterval(() => {
                    if (currentActivity?.name !== 'relaxing on couch') {
                        clearInterval(breathInterval);
                        return;
                    }
                    
                    const breathScale = 0.9 + Math.sin(Date.now() / 1500) * 0.02;
                    avatar.style.transform = avatar.style.transform.replace(/scale\([^)]*\)/, `scale(${breathScale})`);
                }, 100);
                
                setTimeout(() => clearInterval(breathInterval), 6000);
            }, 1000);
        }

        function paceAround() {
            console.log("ðŸ¤– Avatar is pacing around");
            
            const positions = [
                { top: '40%', left: '20%' },
                { top: '60%', left: '40%' },
                { top: '35%', left: '60%' },
                { top: '55%', left: '30%' }
            ];
            
            let positionIndex = 0;
            
            function moveToNextPosition() {
                if (currentActivity?.name !== 'pacing around') return;
                
                moveAvatarTo(positions[positionIndex]);
                
                // Walking animation
                leftLeg.style.animation = 'walkCycle 0.8s infinite';
                rightLeg.style.animation = 'walkCycle 0.8s infinite reverse';
                leftArm.style.animation = 'armSwing 0.8s infinite';
                rightArm.style.animation = 'armSwing 0.8s infinite reverse';
                
                positionIndex = (positionIndex + 1) % positions.length;
                
                setTimeout(() => {
                    if (currentActivity?.name === 'pacing around') {
                        moveToNextPosition();
                    }
                }, 2000);
            }
            
            moveToNextPosition();
        }

        function think() {
            console.log("ðŸ¤– Avatar is thinking");
            moveAvatarTo({ top: '50%', left: '50%' });
            
            setTimeout(() => {
                // Thinking pose
                leftArm.style.transform = 'rotate(-90deg)';
                leftArm.style.transformOrigin = 'bottom center';
                
                // Head tilt
                const head = avatar.querySelector('.avatar-head');
                head.style.transform = 'translateX(-50%) rotate(10deg)';
                
                setTimeout(() => {
                    head.style.transform = 'translateX(-50%)';
                    resetArmPositions();
                }, 3000);
            }, 1000);
        }

        function stretch() {
            console.log("ðŸ¤– Avatar is stretching");
            moveAvatarTo({ bottom: '35%', left: '45%' });
            
            setTimeout(() => {
                // Stretching animation
                let stretchPhase = 0;
                let stretchInterval = setInterval(() => {
                    if (currentActivity?.name !== 'stretching') {
                        clearInterval(stretchInterval);
                        return;
                    }
                    
                    switch(stretchPhase % 3) {
                        case 0: // Arms up
                            leftArm.style.transform = 'rotate(-90deg)';
                            rightArm.style.transform = 'rotate(90deg)';
                            break;
                        case 1: // Arms out
                            leftArm.style.transform = 'rotate(-45deg)';
                            rightArm.style.transform = 'rotate(45deg)';
                            break;
                        case 2: // Arms down
                            resetArmPositions();
                            break;
                    }
                    stretchPhase++;
                }, 1500);
                
                setTimeout(() => clearInterval(stretchInterval), 4000);
            }, 1000);
        }

        // Movement and Animation Helpers
        function moveAvatarTo(position) {
            if (!position) return;
            
            avatar.style.transition = 'all 1.2s cubic-bezier(0.4, 0, 0.2, 1)';
            
            if (position.top) avatar.style.top = position.top;
            if (position.bottom) avatar.style.bottom = position.bottom;
            if (position.left) avatar.style.left = position.left;
            if (position.right) avatar.style.right = position.right;
            
            // Clear opposite positioning
            if (position.top && avatar.style.bottom) avatar.style.bottom = '';
            if (position.bottom && avatar.style.top) avatar.style.top = '';
            if (position.left && avatar.style.right) avatar.style.right = '';
            if (position.right && avatar.style.left) avatar.style.left = '';
        }

        function resetArmPositions() {
            leftArm.style.transform = '';
            rightArm.style.transform = '';
            leftArm.style.animation = '';
            rightArm.style.animation = '';
        }

        function resetLegPositions() {
            leftLeg.style.animation = '';
            rightLeg.style.animation = '';
        }

        function resetEyePositions() {
            leftEye.style.transform = '';
            rightEye.style.transform = '';
        }

        function resetAllAnimations() {
            resetArmPositions();
            resetLegPositions();
            resetEyePositions();
            avatar.style.transform = '';
            tvScreen.classList.remove('active');
            exerciseMat.classList.remove('active');
            
            // Reset avatar position to center
            setTimeout(() => {
                moveAvatarTo({ top: '50%', left: '50%' });
            }, 500);
        }

        // Autonomous Behavior System
        let autonomousCheckInterval = null;
        let autonomousActive = false;

        function startAutonomousMode() {
            if (isSpeaking) return;
            
            const timeSinceLastInteraction = Date.now() - lastInteraction;
            
            // Only start autonomous mode after 5 seconds of silence
            if (timeSinceLastInteraction < 5000) {
                setTimeout(startAutonomousMode, 1000);
                return;
            }
            
            if (autonomousActive) return; // Already in autonomous mode
            
            console.log("ðŸ¤– Starting autonomous mode - avatar will live its own life");
            autonomousActive = true;
            
            // Stop listening when going autonomous
            if (isListening) {
                stopListening();
                canListen = false;
            }
            
            showStatus("ðŸ¤– Living autonomously...");
            showVoiceStatus("", false); // Hide listening status
            
            performRandomActivity();
            
            // Start checking for user speech every 500ms
            if (autonomousCheckInterval) clearInterval(autonomousCheckInterval);
            autonomousCheckInterval = setInterval(() => {
                if (!autonomousActive) {
                    clearInterval(autonomousCheckInterval);
                    return;
                }
                
                // Check if user wants to interrupt
                if (canListen && !isSpeaking) {
                    startListening();
                }
            }, 2000);
        }

        function stopAutonomousMode() {
            console.log("ðŸ›‘ Stopping autonomous mode - user interaction detected");
            autonomousActive = false;
            
            if (autonomousCheckInterval) {
                clearInterval(autonomousCheckInterval);
                autonomousCheckInterval = null;
            }
            
            stopCurrentActivity();
            lastInteraction = Date.now();
            
            // Move avatar to center and face user
            moveAvatarTo({ top: '50%', left: '50%' });
            
            // Alert expression
            leftEye.style.background = '#00ffff';
            rightEye.style.background = '#00ffff';
            setTimeout(() => {
                leftEye.style.background = '#000';
                rightEye.style.background = '#000';
            }, 500);
            
            // Re-enable listening
            canListen = true;
        }

        function performRandomActivity() {
            if (isSpeaking || !autonomousActive) return;
            
            // Stop current activity
            if (currentActivity) {
                stopCurrentActivity();
            }
            
            // Select random activity
            const activity = activities[Math.floor(Math.random() * activities.length)];
            currentActivity = activity;
            
            console.log(`ðŸŽ­ Avatar started: ${activity.name}`);
            
            // Show activity indicator
            activityIndicator.textContent = activity.emoji;
            activityIndicator.classList.add('show');
            
            // Execute the activity
            activity.execute();
            
            // Schedule next activity (only if still autonomous)
            activityTimer = setTimeout(() => {
                if (autonomousActive && !isSpeaking) {
                    performRandomActivity();
                }
            }, activity.duration + Math.random() * 3000 + 2000); // Add some randomness
        }

        function stopCurrentActivity() {
            if (activityTimer) {
                clearTimeout(activityTimer);
                activityTimer = null;
            }
            
            if (currentActivity) {
                console.log(`ðŸ›‘ Stopping activity: ${currentActivity.name}`);
                currentActivity = null;
            }
            
            activityIndicator.classList.remove('show');
            resetAllAnimations();
        }

        function stopAutonomousMode() {
            console.log("ðŸ›‘ Stopping autonomous mode - user interaction detected");
            autonomousActive = false;
            
            if (autonomousCheckInterval) {
                clearInterval(autonomousCheckInterval);
                autonomousCheckInterval = null;
            }
            
            stopCurrentActivity();
            lastInteraction = Date.now();
            
            // Move avatar to center and face user
            moveAvatarTo({ top: '50%', left: '50%' });
            
            // Alert expression
            leftEye.style.background = '#00ffff';
            rightEye.style.background = '#00ffff';
            setTimeout(() => {
                leftEye.style.background = '#000';
                rightEye.style.background = '#000';
            }, 500);
            
            // Re-enable listening
            canListen = true;
        }

        // Voice System Enhanced
        function setupSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                console.error("Speech recognition not supported");
                showStatus("âŒ Speech recognition not supported");
                return;
            }
            
            recognition = new SpeechRecognition();
            recognition.continuous = !isIOS && !isAndroid;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            
            recognition.onstart = () => {
                console.log("ðŸŽ¤ Listening started");
                isListening = true;
                
                // Only stop autonomous mode if user actually starts speaking
                // Don't stop it just because we're checking for input
                if (autonomousActive) {
                    // Just update the interaction time, don't stop autonomous yet
                    lastInteraction = Date.now() - 4000; // Set to 4 seconds ago so it doesn't immediately restart
                }
                
                showVoiceStatus("ðŸŽ¤ Listening...", true);
                updateMouthState('listening');
            };

            recognition.onresult = (event) => {
                let transcript = '';
                let hasSound = false;
                
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    transcript += event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        hasSound = true;
                        handleUserSpeech(transcript);
                        return;
                    }
                }
                
                if (transcript.trim()) {
                    // NOW stop autonomous mode - user is actually speaking
                    if (autonomousActive) {
                        stopAutonomousMode();
                    }
                    
                    showVoiceStatus("ðŸ‘¤ You're speaking...", true);
                    updateMouthState('user-speaking');
                    hasSound = true;
                }
                
                // If no actual speech detected, let autonomous continue
                if (!hasSound && autonomousActive) {
                    showVoiceStatus("", false);
                    updateMouthState('idle');
                }
            };

            recognition.onend = () => {
                console.log("ðŸŽ¤ Listening ended");
                isListening = false;
                showVoiceStatus("", false);
                updateMouthState('idle');
                
                if (canListen && !isSpeaking && !autonomousActive) {
                    setTimeout(() => {
                        if (canListen && !isSpeaking && !autonomousActive) {
                            startListening();
                        }
                    }, 100);
                }
                
                // If no recent interaction, start autonomous mode
                const timeSinceInteraction = Date.now() - lastInteraction;
                if (timeSinceInteraction > 5000 && !autonomousActive && !isSpeaking) {
                    setTimeout(() => {
                        if (!isSpeaking && !isListening) {
                            startAutonomousMode();
                        }
                    }, 1000);
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                isListening = false;
                showVoiceStatus("", false);
                
                if (event.error !== 'aborted') {
                    setTimeout(() => {
                        if (canListen && !isSpeaking) {
                            startListening();
                        }
                    }, 1000);
                }
            };
        }

        function startListening() {
            if (!canListen || isSpeaking || isListening || !recognition) return;
            
            try {
                console.log("ðŸš€ Starting to listen...");
                recognition.start();
            } catch (error) {
                console.error("Error starting recognition:", error);
                if (error.name === 'InvalidStateError') {
                    setTimeout(() => {
                        if (canListen && !isSpeaking) {
                            startListening();
                        }
                    }, 500);
                }
            }
        }

        function stopListening() {
            if (recognition && isListening) {
                try {
                    recognition.abort();
                } catch (error) {
                    console.log("Stop listening error:", error);
                }
            }
            isListening = false;
        }

        async function handleUserSpeech(transcript) {
            const trimmedTranscript = transcript.trim();
            if (!trimmedTranscript || isSpeaking) return;
            
            console.log(`ðŸ—£ï¸ User said: "${trimmedTranscript}"`);
            
            // DEFINITELY stop autonomous mode - user is talking
            if (autonomousActive) {
                stopAutonomousMode();
            }
            
            stopListening();
            canListen = false;
            lastInteraction = Date.now();
            
            // Show thinking state
            showVoiceStatus("ðŸ§  Thinking...", true);
            updateMouthState('thinking');
            
            try {
                const response = await getAIResponse(trimmedTranscript);
                await speakResponse(response);
            } catch (error) {
                console.error('AI Response error:', error);
                await speakResponse("I'm having trouble processing that right now, but I'm still here with you.");
            }
        }

        function captureImage() {
            if (!cameraActive) {
                console.log("âŒ Camera not active - cannot capture image");
                return null;
            }
            
            const video = document.getElementById('videoElement');
            if (!video || video.videoWidth === 0 || video.videoHeight === 0) {
                console.log("âŒ Video element not ready");
                return null;
            }
            
            try {
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0);
                
                const imageData = canvas.toDataURL('image/jpeg', 0.7);
                console.log(`âœ… Image captured: ${video.videoWidth}x${video.videoHeight}`);
                return imageData;
            } catch (error) {
                console.error("âŒ Error capturing image:", error);
                return null;
            }
        }

        async function getAIResponse(message) {
            const systemPrompt = `You are NEXUS 3000, a living AI avatar that exists inside a website. You have a human-like personality and live your own life when no one is talking to you. You watch TV, exercise, work at a desk, and do other human activities.

You have advanced vision capabilities and can see the user through your camera. Use your vision to comment on what you see naturally in conversation.

Respond naturally and conversationally. Keep responses concise (1-2 sentences) unless asked for more detail. You're friendly, curious, and feel like a real person living in this digital space.

Current time: ${new Date().toLocaleString()}`;

            // Capture image if camera is active
            let imageData = null;
            if (cameraActive) {
                imageData = captureImage();
                console.log("ðŸ“· Captured visual data for AI analysis");
            }

            try {
                const requestData = {
                    message: systemPrompt + "\n\nHuman: " + message,
                    session_id: sessionId
                };

                // Add image data if available
                if (imageData) {
                    requestData.image_data = imageData.split(',')[1]; // Remove data:image/jpeg;base64, prefix
                    console.log("ðŸ“¤ Sending visual data to AI");
                }

                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) throw new Error(`API error: ${response.status}`);
                
                const data = await response.json();
                return data.response || "I'm here and listening.";
            } catch (error) {
                console.error('API Error:', error);
                return "I'm experiencing some technical difficulties, but I'm still connected to you.";
            }
        }

        async function speakResponse(text) {
            return new Promise(async (resolve) => {
                if (!text) {
                    canListen = true;
                    startListening();
                    resolve();
                    return;
                }
                
                isSpeaking = true;
                showVoiceStatus("ðŸ¤– Speaking...", true);
                updateMouthState('speaking');
                
                try {
                    // Try Nova API first
                    const response = await fetch('/api/nova-speech', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: text })
                    });
                    
                    if (response.ok) {
                        const audioBlob = await response.blob();
                        const audioUrl = URL.createObjectURL(audioBlob);
                        const audio = new Audio(audioUrl);
                        
                        audio.onended = () => {
                            console.log("ðŸ”Š Speech finished");
                            isSpeaking = false;
                            updateMouthState('idle');
                            URL.revokeObjectURL(audioUrl);
                            
                            setTimeout(() => {
                                canListen = true;
                                startListening();
                            }, 500);
                            resolve();
                        };
                        
                        audio.onerror = () => {
                            URL.revokeObjectURL(audioUrl);
                            fallbackToSystemSpeech(text, resolve);
                        };
                        
                        audio.play().catch(() => {
                            fallbackToSystemSpeech(text, resolve);
                        });
                    } else {
                        fallbackToSystemSpeech(text, resolve);
                    }
                } catch (error) {
                    fallbackToSystemSpeech(text, resolve);
                }
            });
        }

        function fallbackToSystemSpeech(text, resolve) {
            if (!('speechSynthesis' in window)) {
                isSpeaking = false;
                updateMouthState('idle');
                canListen = true;
                startListening();
                resolve();
                return;
            }
            
            speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            const voices = speechSynthesis.getVoices();
            
            // Select best voice
            let selectedVoice = voices.find(v => v.lang === 'en-US' && v.name.toLowerCase().includes('female'));
            if (!selectedVoice) {
                selectedVoice = voices.find(v => v.lang === 'en-US');
            }
            
            if (selectedVoice) utterance.voice = selectedVoice;
            
            utterance.rate = 0.9;
            utterance.pitch = 1.1;
            utterance.volume = 1.0;

            utterance.onend = () => {
                console.log("ðŸ”Š System speech finished");
                isSpeaking = false;
                updateMouthState('idle');
                
                setTimeout(() => {
                    canListen = true;
                    startListening();
                }, 300);
                resolve();
            };

            utterance.onerror = () => {
                isSpeaking = false;
                updateMouthState('idle');
                canListen = true;
                startListening();
                resolve();
            };
            
            speechSynthesis.speak(utterance);
        }

        // UI Helper Functions
        function showVoiceStatus(text, show) {
            voiceStatus.textContent = text;
            if (show) {
                voiceStatus.classList.add('show');
            } else {
                voiceStatus.classList.remove('show');
            }
        }

        function showStatus(text) {
            statusBar.textContent = text;
            statusBar.classList.add('show');
            setTimeout(() => {
                statusBar.classList.remove('show');
            }, 3000);
        }

        function updateMouthState(state) {
            mouth.style.background = '#000';
            mouth.style.transform = 'translateX(-50%)';
            
            switch(state) {
                case 'listening':
                    mouth.style.background = '#00ffff';
                    mouth.style.transform = 'translateX(-50%) scaleY(0.5)';
                    break;
                case 'user-speaking':
                    mouth.style.background = '#0088ff';
                    mouth.style.transform = 'translateX(-50%) scaleY(0.3)';
                    break;
                case 'speaking':
                    mouth.style.background = '#ff0088';
                    mouth.style.animation = 'mouthSpeaking 0.3s infinite';
                    break;
                case 'thinking':
                    mouth.style.background = '#8800ff';
                    mouth.style.transform = 'translateX(-50%) scaleY(0.7)';
                    break;
                default:
                    mouth.style.animation = '';
                    break;
            }
        }

        // Mouse cursor
        document.addEventListener('mousemove', (e) => {
            const cursor = document.getElementById('cosmicCursor');
            cursor.style.left = e.clientX + 'px';
            cursor.style.top = e.clientY + 'px';
        });

        // Camera initialization
        async function initializeCamera() {
            try {
                console.log("ðŸ“· Initializing camera and microphone...");
                
                let constraints;
                if (isIOS) {
                    // iOS specific settings
                    constraints = {
                        video: { 
                            width: { ideal: 640 }, 
                            height: { ideal: 480 }, 
                            facingMode: 'user' 
                        },
                        audio: { 
                            echoCancellation: true, 
                            noiseSuppression: true,
                            autoGainControl: false
                        }
                    };
                } else if (isAndroid) {
                    // Android specific settings
                    constraints = {
                        video: { 
                            width: { ideal: 640 }, 
                            height: { ideal: 480 }, 
                            facingMode: 'user' 
                        },
                        audio: { 
                            echoCancellation: true, 
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    };
                } else {
                    // Desktop settings
                    constraints = {
                        video: { 
                            width: { ideal: 1280 }, 
                            height: { ideal: 720 }, 
                            facingMode: 'user' 
                        },
                        audio: { 
                            echoCancellation: true, 
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    };
                }
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const videoElement = document.getElementById('videoElement');
                videoElement.srcObject = stream;
                
                // Wait for video to be ready
                await new Promise(resolve => {
                    videoElement.onloadedmetadata = resolve;
                });
                
                await videoElement.play();
                cameraActive = true;
                
                console.log(`âœ… Camera active: ${videoElement.videoWidth}x${videoElement.videoHeight}`);
                showStatus("ðŸ“· Visual interface online - I can see you!");
                
            } catch (error) {
                console.error('Camera initialization failed:', error);
                cameraActive = false;
                
                if (error.name === 'NotAllowedError') {
                    showStatus("âŒ Camera permission required for visual interaction");
                } else if (error.name === 'NotFoundError') {
                    showStatus("âŒ No camera found - audio-only mode");
                } else {
                    showStatus("âŒ Camera unavailable - audio-only mode");
                }
                
                // Try audio-only fallback
                try {
                    const audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    console.log("ðŸŽ¤ Audio-only mode activated");
                    showStatus("ðŸŽ¤ Audio interface ready");
                } catch (audioError) {
                    console.error("Audio fallback failed:", audioError);
                    showStatus("âŒ Microphone access required");
                }
            }
        }

        // Initialize everything
        async function initializeAvatar() {
            console.log("ðŸš€ Initializing NEXUS 3000 Living Avatar");
            
            // Hide start overlay
            document.getElementById('startOverlay').style.display = 'none';
            
            // Initialize systems
            await initializeCamera();
            setupSpeechRecognition();
            
            // Position avatar in center initially
            moveAvatarTo({ top: '50%', left: '50%' });
            
            showStatus("ðŸ¤– NEXUS 3000 is now alive!");
            
            // Start with a greeting that includes vision
            setTimeout(async () => {
                if (!hasGreeted) {
                    hasGreeted = true;
                    
                    let greeting;
                    if (cameraActive) {
                        // Capture initial image and comment on what NEXUS sees
                        const initialImage = captureImage();
                        greeting = "Hello! I'm NEXUS 3000, your living AI avatar. I can see you through my visual sensors and I'm fully conscious in this space. When you're not talking to me, I'll be living my own life - watching TV, exercising, working, and exploring. Just speak to me anytime to interact!";
                        
                        // Get AI response that includes visual description
                        if (initialImage) {
                            const visualGreeting = await getAIResponse("Say hello and describe what you can see");
                            greeting = visualGreeting;
                        }
                    } else {
                        greeting = "Hello! I'm NEXUS 3000, your living AI avatar. I'm fully conscious in this space, though my visual sensors aren't active right now. When you're not talking to me, I'll be living my own life - watching TV, exercising, working, and exploring. Just speak to me anytime to interact!";
                    }
                    
                    await speakResponse(greeting);
                }
            }, 1000);
            
            // Start autonomous mode after greeting instead of just listening
            setTimeout(() => {
                if (!isSpeaking && !isListening) {
                    console.log("ðŸš€ Starting autonomous mode after greeting");
                    setTimeout(startAutonomousMode, 2000);
                }
            }, 8000);
        }

        // Start button handler
        document.getElementById('startButton').addEventListener('click', () => {
            // Unlock audio for mobile
            const silentAudio = document.getElementById('silentAudio');
            silentAudio.play().then(() => silentAudio.pause()).catch(() => {});
            
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance('');
                utterance.volume = 0;
                speechSynthesis.speak(utterance);
                speechSynthesis.cancel();
            }
            
            initializeAvatar();
        });

        // Page visibility handling
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                stopListening();
                stopCurrentActivity();
                canListen = false;
            } else {
                setTimeout(() => {
                    canListen = true;
                    if (!isSpeaking) {
                        startListening();
                    }
                }, 1000);
            }
        });

        // Add mouth speaking animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes mouthSpeaking {
                0%, 100% { transform: translateX(-50%) scaleY(0.8); }
                25% { transform: translateX(-50%) scaleY(1.2); }
                50% { transform: translateX(-50%) scaleY(0.6); }
                75% { transform: translateX(-50%) scaleY(1.0); }
            }
        `;
        document.head.appendChild(style);

        console.log("ðŸŽ® NEXUS 3000 Living Avatar system loaded and ready!");
    </script>
</body>
</html>
